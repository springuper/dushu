// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// 枚举类型
// ============================================

enum PersonRole {
  MONARCH          // 君主
  ADVISOR          // 谋士
  GENERAL          // 将领
  CIVIL_OFFICIAL   // 文臣
  MILITARY_OFFICIAL // 武将
  RELATIVE         // 外戚
  EUNUCH           // 宦官
  OTHER            // 其他
}

enum Faction {
  HAN      // 汉
  CHU      // 楚
  NEUTRAL  // 中立
  OTHER    // 其他
}

enum EventType {
  BATTLE    // 战役
  POLITICAL // 政治事件
  PERSONAL  // 人物事件
  OTHER     // 其他
}

enum TimePrecision {
  EXACT_DATE   // 精确到日
  MONTH        // 精确到月
  SEASON       // 精确到季节
  YEAR         // 精确到年
  DECADE       // 精确到十年
  APPROXIMATE  // 大致时间
}

enum ContentStatus {
  DRAFT      // 草稿
  PENDING    // 待审核
  APPROVED   // 已审核通过
  PUBLISHED  // 已发布
  REJECTED   // 已拒绝
}

// ============================================
// 书籍相关模型
// ============================================

// 书籍
model Book {
  id            String    @id @default(uuid())
  name          String    // 书名，如 "史记"
  nameEn        String?   // 英文名/拼音，如 "shiji"
  author        String?   // 作者，如 "司马迁"
  dynasty       String?   // 朝代，如 "西汉"
  writtenYear   String?   // 成书年代，如 "公元前91年"
  description   String?   @db.Text // 书籍简介
  sourceUrl     String?   // 来源链接，如维基文库URL
  totalChapters Int       @default(0) // 总章节数
  status        ContentStatus @default(DRAFT)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  chapters      Chapter[]

  @@unique([nameEn])
  @@index([name])
  @@index([status])
}

// 章节
model Chapter {
  id             String   @id @default(uuid())
  bookId         String   // 书籍ID
  title          String   // 章节标题
  summary        String   @db.Text // 章节简介
  order          Int      // 章节顺序
  totalParagraphs Int     @default(0) // 段落总数
  timeRangeStart String?  // 时间范围开始, 如 "公元前256年"
  timeRangeEnd   String?  // 时间范围结束
  sourceUrl      String?  // 来源链接
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  book           Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  paragraphs     Paragraph[]
  events         Event[]

  @@index([bookId])
  @@index([order])
}

// 段落
model Paragraph {
  id            String   @id @default(uuid())
  chapterId     String
  order         Int      // 段落顺序
  text          String   @db.Text // 段落原文
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  chapter       Chapter      @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  annotations   Annotation[]

  @@index([chapterId])
  @@index([order])
}

// 注释
model Annotation {
  id          String   @id @default(uuid())
  paragraphId String
  targetText  String   // 被注释的文本
  explanation String   @db.VarChar(200) // 注释内容, 最多60字（实际存储200字符）
  position    Int      // 在段落中的位置（字符索引）
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  paragraph   Paragraph @relation(fields: [paragraphId], references: [id], onDelete: Cascade)

  @@index([paragraphId])
}

// ============================================
// 核心数据模型（事件中心）
// ============================================

// 事件 - 核心原子数据单元
// actors 字段格式: [{ personId?: string, name: string, roleType: string, description?: string }]
model Event {
  id                 String        @id @default(uuid())
  name               String        // 事件名称
  type               EventType
  timeRangeStart     String        // 开始时间
  timeRangeEnd       String?       // 结束时间
  timePrecision      TimePrecision @default(YEAR)
  
  // 地点信息（JSON 内嵌，不再单独建表）
  locationName       String?       // 历史地名
  locationModernName String?       // 现代地名
  
  // 内容
  summary            String        @db.Text // 事件简述
  impact             String?       @db.Text // 影响描述
  
  // 参与者（JSON 内嵌）
  // 格式: [{ personId: string|null, name: string, roleType: string, description?: string }]
  actors             Json          @default("[]")
  
  // 来源
  chapterId          String
  relatedParagraphs  String[]      // 相关段落ID列表
  
  status             ContentStatus @default(DRAFT)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  chapter            Chapter       @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
  @@index([name])
  @@index([type])
  @@index([timeRangeStart])
  @@index([status])
}

// 人物 - 跨章节聚合信息
model Person {
  id               String        @id @default(uuid())
  name             String        // 姓名
  aliases          String[]      // 别称数组（PostgreSQL 数组）
  role             PersonRole
  faction          Faction
  birthYear        String?       // 生年
  deathYear        String?       // 卒年
  biography        String        @db.Text // 简介
  portraitUrl      String?       // 画像链接
  
  // 来源追踪
  sourceChapterIds String[]      // 信息来源章节ID列表
  
  status           ContentStatus @default(DRAFT)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([name])
  @@index([faction])
  @@index([role])
  @@index([status])
}

// ============================================
// 管理与审核模型
// ============================================

// 管理员
model Admin {
  id        String   @id @default(uuid())
  username  String   @unique
  passwordHash String // bcrypt 加密后的密码
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([username])
}

// Review 项目（待审核的数据）
model ReviewItem {
  id          String        @id @default(uuid())
  type        ReviewItemType // 类型：事件/人物
  status      ReviewStatus  @default(PENDING)
  source      ReviewSource  @default(LLM_EXTRACT) // 来源：LLM 提取/手动录入
  originalData Json         // 原始数据（LLM 提取的 JSON）
  modifiedData Json?        // 修正后的数据（可编辑）
  reviewerNotes String?     @db.Text // 审核备注
  reviewedBy   String?      // 审核人 ID
  reviewedAt   DateTime?    // 审核时间
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([type])
  @@index([status])
  @@index([source])
  @@index([createdAt])
}

// 简化后的 ReviewItemType - 只有事件和人物
enum ReviewItemType {
  EVENT        // 事件
  PERSON       // 人物
}

enum ReviewStatus {
  PENDING   // 待审核
  APPROVED  // 已通过
  REJECTED  // 已拒绝
  MODIFIED  // 已修改
}

enum ReviewSource {
  LLM_EXTRACT // LLM 提取
  MANUAL      // 手动录入
}

// 变更日志（记录所有数据变更）
model ChangeLog {
  id            String        @id @default(uuid())
  entityType    String        // 实体类型：PERSON, EVENT
  entityId      String        // 实体ID
  action        ChangeAction  // 变更操作
  version       Int           @default(1) // 版本号
  previousData  Json?         // 变更前的数据（完整快照）
  currentData   Json          // 变更后的数据（完整快照）
  changes       Json?         // 变更详情（diff，可选）
  changedBy     String?       // 变更人ID（管理员ID）
  changeReason  String?       @db.Text // 变更原因
  mergedFrom    String[]      // 如果是从其他记录合并而来，记录源记录ID
  createdAt     DateTime      @default(now())

  @@index([entityType, entityId])
  @@index([entityType, entityId, version])
  @@index([createdAt])
}

enum ChangeAction {
  CREATE      // 创建
  UPDATE      // 更新
  MERGE       // 合并
  DELETE      // 删除
}
