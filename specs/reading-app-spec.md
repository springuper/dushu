# 历史阅读增强 App 产品规格书（MVP）

> 文档目的：定义 MVP 级别的用户价值、核心流程与功能要求，为前后端团队提供统一的交付目标与验收依据。

---

## 1. 背景与目标

### 1.1 项目背景
- 传统历史文本阅读存在信息碎片、人物关系模糊、地理感缺失的问题，导致理解效率低。
- 大语言模型具备总结与对话能力，可辅助读者探索复杂叙事；同时已有大量可靠历史研究资料可结构化整理。
- 目标是在 Web 端提供“多维度上下文+LLM 互动”体验，先聚焦《史记》《资治通鉴》部分章节，验证价值。

### 1.2 产品愿景
> “让读者在阅读经典历史时，实时获得人物、地理、关系与事件的全景 context，像和历史导师对话一样深入理解背景。”

### 1.3 MVP 范围
- 支持 1 本书（推荐《史记》选章，10～15 章）在 App 内阅读。
- 覆盖阅读区 + 信息侧栏 + LLM 问答 + 简易内容管理。
- 优先保障单用户体验（无账号体系），内容由内部编辑预置。

---

## 2. 目标用户与场景

### 2.1 用户画像
1. **历史深度读者**  
   - 年龄 25-45，具备基础历史知识，常阅读史学著作。  
   - 诉求：快速理解复杂人物关系、战役背景、地理位置等，减少查阅资料时间。
2. **知识型创作者/学生**  
   - 需要整理笔记、写作或备考，对史料准确性敏感。  
   - 诉求：高效检索角色与事件、获得概括与对比材料。

### 2.2 使用动机
- 解决阅读过程中的即时疑问（人物是谁、在哪、为何行动）。
- 构建宏观理解（势力分布、时间线、事件影响）。
- 借助 LLM 进行“导读式”对话，获得更具结构的见解。

### 2.3 典型场景
1. 夜间阅读《史记·高祖本纪》，想确认刘邦与萧何关系及其演变。
2. 课题写作者需要梳理楚汉战争主要战役地点与作战时间。
3. 对段落有疑问（如“为什么韩信在此时北上？”），希望即时提问获得引用明确的回答。

---

## 3. 成功指标

### 3.1 用户价值指标
- 70% 以上的阅读 session 触发至少 1 次信息面板互动（人物/地图/关系图）。
- 用户自评（调查）中，≥80% 认为 App 提升了理解效率。

### 3.2 业务指标
- MVP 阶段：核心用户（内部或小规模灰度）每周活跃率 ≥60%。
- 阅读完成度：选定章节中，人均完成 ≥3 章。

### 3.3 体验指标
- 页面在 3G/4G 网络下首屏加载 ≤3s，后续面板切换 ≤500ms。
- LLM 响应时间 ≤6s（含上下文构建）。

---

## 4. 用户旅程

### 4.1 主阅读流（详细步骤）

**步骤 1：进入 App**
- 用户访问 Web 地址（如 `https://dushu.app`）
- 系统检查是否有本地存储的阅读进度
- 如有进度：显示首页，顶部显示"继续阅读"卡片（显示最近阅读的章节、进度百分比）
- 如无进度：显示章节列表

**步骤 2：选择章节**
- 用户点击"继续阅读"或从章节列表选择
- 系统加载章节数据（显示加载动画，预计 1-2 秒）
- 加载完成后进入阅读界面

**步骤 3：阅读界面初始化**
- 左侧阅读区：显示章节标题、段落列表
- 右侧信息面板：默认显示"人物"标签页，加载当前章节相关人物（显示加载状态）
- 顶部进度条：显示当前阅读进度（如有保存进度，自动定位）
- 如有保存进度：弹出提示"检测到上次阅读位置，是否继续？"，用户选择后滚动到对应段落

**步骤 4：滚动阅读**
- 用户滚动页面阅读原文
- 进度条实时更新（每 100ms 更新一次）
- 当滚动到新段落时：
  - 右侧人物面板自动更新（高亮当前段落相关人物）
  - 如当前段落有新人物出现，人物列表顶部显示"新出现"标签

**步骤 5：交互查询**
- 用户 hover 段落中的人物名称（如"刘邦"）
- 人物名称高亮显示（黄色背景）
- 用户点击高亮文本
- 弹出浮层卡片，显示人物基本信息
- 用户可点击"查看详情"，右侧面板切换到该人物的完整信息
- 用户可点击"在地图上查看"，切换到地图视图并定位到相关地点

**步骤 6：切换信息面板**
- 用户点击右侧面板的"关系"标签
- 系统加载关系图谱数据（显示加载动画）
- 图谱渲染完成，显示当前章节核心人物关系
- 用户点击某个节点（如"刘邦"）
- 节点放大，显示详细信息浮层
- 用户点击"查看详情"，右侧面板切换到该人物信息

**步骤 7：保存进度**
- 用户滚动停止 500ms 后，系统自动保存阅读进度到 localStorage
- 保存成功：无提示（静默保存）
- 保存失败：显示提示"进度保存失败，请检查浏览器设置"

**边界情况处理**：
- 网络断开：显示"网络连接已断开，部分功能可能不可用"
- 数据加载失败：显示错误提示，提供"重试"按钮
- 浏览器不支持 localStorage：显示提示，但不影响阅读功能

### 4.2 查询 / 探索流（详细步骤）

**步骤 1：打开人物列表**
- 用户点击右侧面板的"人物"标签（如未打开）
- 系统加载人物列表数据
- 列表按出现频次排序显示

**步骤 2：筛选人物**
- 用户点击"阵营"筛选器，选择"汉"
- 列表立即更新，只显示汉阵营人物（显示筛选数量：如"共 15 人"）
- 用户再点击"角色类型"下拉，选择"谋士"
- 列表进一步筛选，显示"共 3 人"（汉阵营 + 谋士角色）

**步骤 3：搜索人物**
- 用户在搜索框输入"萧"
- 系统实时搜索（300ms 防抖），高亮匹配文字
- 显示匹配结果（如"萧何"）
- 用户点击结果项，右侧面板显示该人物详情

**步骤 4：查看关系图谱**
- 用户切换到"关系"标签
- 系统加载关系数据，渲染图谱（显示加载动画）
- 图谱初始布局：核心人物居中，次要人物围绕
- 用户拖拽节点"刘邦"到新位置
- 节点移动，其他节点自动调整位置（200ms 动画）
- 用户 hover 关系线（刘邦-萧何）
- 关系线高亮，显示浮层："上下级关系，详见《史记·高祖本纪》"
- 用户点击关系线
- 右侧面板显示关系详情（双方信息、关系描述、重要事件）

**步骤 5：查看地图**
- 用户切换到"地图"标签
- 系统加载地图数据和地点标记
- 地图自动适配所有地点，显示标记
- 用户点击标记"沛县"
- 弹出信息卡片，显示地点信息、相关事件
- 用户点击"前往原文"
- 阅读区域滚动到首次出现"沛县"的段落，段落高亮 3 秒

**步骤 6：查看时间轴**
- 用户切换到"时间轴"标签
- 系统加载事件数据，渲染时间轴
- 时间轴显示关键事件节点
- 用户点击节点"鸿门宴"
- 右侧面板显示事件详情（时间、地点、参与人物、描述）
- 用户点击"前往原文"
- 阅读区域滚动到相关段落

**边界情况处理**：
- 无匹配结果：显示"未找到匹配项"，提供"清除筛选"按钮
- 图谱加载失败：显示错误提示，提供"重试"按钮
- 地图标记过多：自动聚合，用户缩放后展开

### 4.3 问答互动流（详细步骤）

**步骤 1：打开问答面板**
- 用户点击右下角悬浮按钮"💬"或右侧面板"问答"标签
- 问答面板展开，显示欢迎语和 3 条建议问题

**步骤 2：查看建议问题**
- 系统基于当前段落自动生成 3 条建议问题（如"刘邦是谁？"、"沛县在哪里？"）
- 建议问题显示在输入框上方，浅蓝色按钮
- 用户点击"刘邦是谁？"
- 问题自动填充到输入框
- 系统自动发送（或用户点击"发送"按钮）

**步骤 3：等待回答**
- 输入框显示"思考中..."，禁用输入
- 系统构建上下文（当前段落、相关人物、地点、章节背景）
- 调用 LLM API，开始流式返回回答

**步骤 4：接收回答**
- 回答逐字显示（流式输出，30 字/秒）
- 回答中自动识别人物/地点/段落引用，添加可点击标签
- 回答完成，显示引用标签和操作按钮（"继续追问"、"复制"）

**步骤 5：查看引用**
- 用户点击引用标签"[人物：刘邦]"
- 弹出人物卡片，显示刘邦基本信息
- 用户点击"查看详情"
- 右侧面板切换到人物详情

**步骤 6：继续追问**
- 用户点击"继续追问"按钮
- 输入框聚焦，预填充"关于上面的回答，我还想了解..."
- 用户修改问题为"刘邦和萧何的关系如何演变？"
- 用户点击"发送"
- 系统保留上一轮对话上下文，发送新问题
- LLM 返回回答，引用相关段落和关系信息

**步骤 7：反馈回答**
- 用户认为回答有误，点击"👎 有误"按钮
- 弹出反馈表单
- 用户填写问题描述和正确信息（可选）
- 用户点击"提交"
- 显示感谢提示："感谢反馈，我们会尽快核实并改进。"
- 反馈数据保存到后端

**边界情况处理**：
- LLM 请求超时（>10 秒）：显示"请求超时，请重试"，提供"重试"按钮
- LLM 返回错误：显示"AI 服务暂时不可用，请稍后再试"
- 网络断开：显示"网络连接已断开，无法提问"
- 上下文过长：自动压缩上下文，保留核心信息

---

## 5. 功能模块说明

### 5.1 阅读与注释

#### 5.1.1 章节导航
**布局与样式**：
- 位置：首页或侧边栏，宽度 280px，支持折叠
- 列表项结构：
  - 章节标题（16px，粗体）
  - 章节简介（12px，灰色，最多 2 行，超出省略）
  - 阅读进度条（4px 高度，蓝色填充，显示百分比）
  - 最后阅读时间（10px，浅灰）
- 交互：
  - hover 时背景色变为 #f5f5f5
  - 点击后进入阅读界面，当前章节高亮显示（左侧边框 3px 蓝色）
  - "最近阅读"入口位于列表顶部，固定显示，最多显示 3 个章节

**数据要求**：
- 章节列表 API 返回：`{ id, title, summary, totalParagraphs, readParagraphs, lastReadAt }`
- 排序规则：最近阅读优先，其次按章节顺序

#### 5.1.2 阅读区
**布局**：
- 左侧阅读区：宽度 60%（最小 600px），居中显示，最大宽度 900px
- 右侧信息面板：宽度 35%（最小 320px），可折叠至 0
- 中间分隔线：1px，可拖拽调整比例（最小左侧 400px，右侧 280px）

**原文展示**：
- 字体：思源宋体或系统默认衬线字体，行高 1.8
- 段落间距：24px
- 段落编号：每段左上角显示 `[段落 3]`，10px 灰色，点击可复制段落 ID
- 行间注释：以 `<sup>` 标记，点击弹出注释卡片（宽度 300px，最大高度 200px，可滚动）

**字号调节**：
- 小号：14px（默认）
- 中号：16px
- 大号：18px
- 控制按钮：位于阅读区右上角，三个按钮横向排列，当前选中状态有蓝色边框

**夜间模式**：
- 背景色：`#1a1a1a`
- 文字色：`#e0e0e0`
- 注释背景：`#2a2a2a`
- 切换按钮：右上角，图标切换（太阳/月亮），点击后 300ms 渐变动画

**滚动与定位**：
- 支持平滑滚动（`scroll-behavior: smooth`）
- 阅读进度条位于页面顶部，实时更新，点击可跳转
- 返回顶部按钮：滚动超过 3 屏后显示，位于右下角

#### 5.1.3 段落交互
**高亮机制**：
- 人物高亮：鼠标 hover 时，人物名称背景变为 `#fff3cd`（浅黄），边框 1px `#ffc107`
- 地点高亮：背景 `#d1ecf1`（浅蓝），边框 `#0dcaf0`
- 高亮区域：支持跨行，自动合并相邻高亮
- 高亮延迟：hover 后 200ms 显示，避免误触

**浮层卡片**：
- 触发：点击高亮文本或侧栏中的人物/地点项
- 位置：跟随鼠标或文本位置，智能避让（优先右上，其次左上、右下、左下）
- 尺寸：宽度 320px，最大高度 400px，超出可滚动
- 内容结构：
  ```
  [头像/图标] 名称（称号）
  ──────────────────────
  阵营：汉 | 角色：谋士
  ──────────────────────
  简介：[2-3 行文字]
  ──────────────────────
  首次出现：高祖本纪·第 2 段
  当前关系：[与段落中其他人物的关系描述]
  ──────────────────────
  [查看详情] [在地图上查看]
  ```
- 动画：淡入 200ms，关闭时淡出 150ms
- 关闭：点击外部区域、ESC 键、或卡片内关闭按钮

**段落关联信息**：
- 每段数据包含：`paragraphId, text, annotations[], relatedPersons[], relatedPlaces[], relatedEvents[]`
- 关联信息在段落加载时预加载，hover 时即时显示

#### 5.1.4 进度同步
**存储机制**：
- 使用 `localStorage`，key 格式：`reading_progress_{chapterId}`
- 存储内容：`{ chapterId, paragraphId, scrollPosition, timestamp }`
- 更新频率：滚动停止后 500ms 保存一次，或切换章节时立即保存

**自动定位**：
- 进入章节时，检查是否有保存的进度
- 如有，显示提示："检测到上次阅读位置，是否继续？[是] [否]"
- 选择"是"后，滚动到对应段落并高亮 2 秒
- 如无保存进度，从段落 1 开始

### 5.2 人物与关系

#### 5.2.1 人物列表
**布局**：
- 位置：右侧信息面板，默认 tab
- 列表项：卡片式，每个卡片高度 120px，间距 12px
- 卡片结构：
  ```
  ┌─────────────────────────┐
  │ [头像] 姓名（称号）      │
  │ 阵营：汉 | 角色：谋士    │
  │ ─────────────────────── │
  │ 关键事件：[摘要文字...]  │
  │ [查看详情] [关系图]      │
  └─────────────────────────┘
  ```

**数据展示**：
- 头像：60x60px 圆形，默认占位图（根据角色类型显示不同图标）
- 称号：12px，灰色，显示在姓名下方
- 阵营标签：彩色圆点 + 文字，汉（红色 #dc3545）、楚（蓝色 #0d6efd）、中立（灰色 #6c757d）
- 关键事件摘要：最多 2 行，超出显示"..."，hover 显示完整内容

**排序规则**：
1. 按在当前章节出现频次降序
2. 频次相同按首次出现段落号升序
3. 支持手动切换为"按姓名拼音"排序

**分页/虚拟滚动**：
- 超过 20 个人物时，使用虚拟滚动，每次渲染可见区域 + 上下各 5 个
- 滚动到底部时，显示"加载更多"（如有）

#### 5.2.2 筛选与搜索
**筛选器**：
- 位置：人物列表顶部，横向排列
- 阵营筛选：多选按钮组，支持"全部"、"汉"、"楚"、"中立"
- 角色类型筛选：下拉多选，选项包括：
  - 君主、谋士、将领、文臣、武将、外戚、宦官、其他
- 筛选状态：选中项高亮（蓝色背景），右上角显示筛选数量徽章

**搜索框**：
- 位置：筛选器下方，宽度 100%
- 功能：实时搜索（输入后 300ms 防抖）
- 搜索范围：姓名、别称、称号、简介
- 高亮匹配：搜索结果中匹配文字高亮显示（黄色背景）
- 空状态：显示"未找到匹配人物"

**组合逻辑**：
- 筛选与搜索为"且"关系（AND）
- 清空按钮：一键清除所有筛选和搜索

#### 5.2.3 关系图谱
**画布设置**：
- 容器：宽度 100%，高度 600px（最小 400px），可全屏展开
- 渲染引擎：使用 vis.js 或 D3.js force-directed layout
- 初始视图：自动布局，核心人物居中，次要人物围绕

**节点设计**：
- 形状：圆形，直径根据重要性动态调整（核心人物 60px，次要 40px，边缘 30px）
- 颜色：根据阵营，汉（红色系）、楚（蓝色系）、中立（灰色系）
- 标签：节点内显示姓名，字体 12px，超出 4 字显示省略
- 悬停：hover 时节点放大 1.2 倍，显示完整信息卡片（同 5.1.3 浮层卡片）

**边（关系线）设计**：
- 盟友关系：绿色实线，宽度 2px
- 敌对关系：红色虚线，宽度 2px
- 上下级关系：蓝色实线，宽度 1.5px，箭头指向下级
- 族亲关系：橙色实线，宽度 1.5px
- 悬停：hover 边时，边高亮（加粗 + 阴影），显示关系描述浮层

**交互功能**：
- 拖拽：可拖拽节点，释放后自动重新布局（200ms 动画）
- 缩放：鼠标滚轮缩放（0.5x - 2x），缩放中心为鼠标位置
- 平移：鼠标中键或拖拽空白区域平移画布
- 重置视图：按钮重置到初始布局和缩放
- 全屏：支持全屏查看，退出 ESC 键

**数据加载**：
- 默认显示当前章节核心 8-12 个角色
- 点击节点可展开其直接关系（加载更多节点和边）
- 加载动画：节点淡入，边从源节点动画绘制到目标节点（500ms）

#### 5.2.4 关系详情
**详情面板**：
- 触发：点击关系图中的边，或人物卡片中的"查看关系"按钮
- 位置：右侧信息面板或浮层（根据上下文）
- 内容结构：
  ```
  ┌─────────────────────────┐
  │ 刘邦 ←→ 萧何            │
  │ 关系类型：上下级/盟友    │
  │ ─────────────────────── │
  │ 关系描述：              │
  │ [2-3 段文字描述关系演变] │
  │ ─────────────────────── │
  │ 重要事件：              │
  │ • 事件1（章节·段落）    │
  │ • 事件2（章节·段落）    │
  │ ─────────────────────── │
  │ 参考来源：              │
  │ 《史记·高祖本纪》       │
  │ 《史记·萧相国世家》     │
  └─────────────────────────┘
  ```

**关系时间线**（可选，MVP 后实现）：
- 显示关系在不同时期的变化
- 时间轴形式，关键节点可点击查看详情

### 5.3 地理与时间

#### 5.3.1 地图视图
**地图组件**：
- 底图：使用 Leaflet.js + OpenStreetMap，或自绘历史地图底图（推荐）
- 容器：宽度 100%，高度 500px（最小 400px），可全屏
- 初始视图：自动适配当前章节所有地点，包含适当边距（padding 50px）

**标记类型**：
- 城池：圆形标记，直径 20px，颜色按势力（汉红、楚蓝、中立灰）
- 战场：菱形标记，红色边框，内部填充半透明红色
- 河流：蓝色线条，宽度 3px，支持曲线
- 山脉：棕色区域，半透明填充
- 标记图标：可自定义 SVG，支持 hover 动画（放大 1.3 倍）

**标记交互**：
- 点击标记：弹出信息卡片（宽度 300px）
  ```
  ┌─────────────────────────┐
  │ 地点名称（现代地名）      │
  │ ─────────────────────── │
  │ 所属势力：汉             │
  │ 坐标：[经度, 纬度]       │
  │ ─────────────────────── │
  │ 相关事件：              │
  │ • 事件1（链接到段落）    │
  │ • 事件2（链接到段落）    │
  │ ─────────────────────── │
  │ 与其他地点：            │
  │ 距咸阳约 200 公里，东北  │
  │ ─────────────────────── │
  │ [查看详情] [前往原文]    │
  └─────────────────────────┘
  ```
- 悬停：显示地点名称 tooltip
- 标记聚合：当地点密集时（缩放级别 < 8），自动聚合显示数量，点击展开

**势力范围**：
- 使用 GeoJSON Polygon 绘制势力范围
- 填充颜色：半透明（opacity 0.3），边框 2px
- 支持时间切换：显示不同时期的势力范围（如有时间维度数据）

**地图控制**：
- 缩放：鼠标滚轮或 +/- 按钮，范围 3-15 级
- 图层切换：支持显示/隐藏不同类型标记（城池、战场、河流）
- 时间筛选：如有时间数据，支持按时间段筛选显示的地点
- 重置视图：按钮回到初始适配视图

**数据要求**：
- 地点数据包含：`id, name, modernName, coordinates: [lng, lat], type, faction, events[], description`
- 支持 GeoJSON 格式导入

#### 5.3.2 时间轴
**时间轴组件**：
- 布局：水平时间轴，高度 200px（可展开至 400px 显示详情）
- 时间刻度：根据章节时间跨度自动计算，支持年/月/日级别
- 节点：圆形标记，直径 12px，颜色按事件类型区分
- 节点标签：事件名称，显示在节点上方或下方（智能避让）

**事件节点**：
- 类型图标：
  - 战役：⚔️ 红色
  - 政治事件：👑 金色
  - 人物事件：👤 蓝色
  - 其他：⚪ 灰色
- 节点大小：根据重要性调整（核心事件 16px，次要 12px，边缘 8px）
- 悬停：显示事件名称和日期 tooltip

**时间轴交互**：
- 点击节点：右侧面板显示事件详情
  ```
  ┌─────────────────────────┐
  │ 事件名称                 │
  │ 时间：公元前 206 年      │
  │ 地点：咸阳               │
  │ ─────────────────────── │
  │ 参与人物：               │
  │ [刘邦] [项羽] [张良]    │
  │ ─────────────────────── │
  │ 事件描述：              │
  │ [2-3 段文字]            │
  │ ─────────────────────── │
  │ [前往原文] [在地图查看]  │
  └─────────────────────────┘
  ```
- 拖拽：可左右拖拽时间轴查看不同时间段
- 缩放：鼠标滚轮缩放时间范围（聚焦到更短或更长的时间段）
- 筛选：支持按事件类型、参与人物筛选

**时间显示**：
- 支持农历/公历切换（如有数据）
- 不确定时间显示为"约公元前 XX 年"或时间段"公元前 XX-XX 年"

#### 5.3.3 跳转联动
**联动机制**：
- 触发源：地图标记、时间轴节点、关系图中的地点/事件节点
- 目标：阅读区域的对应段落
- 执行流程：
  1. 点击节点/标记
  2. 显示加载提示（200ms）
  3. 阅读区域滚动到目标段落（平滑滚动，500ms）
  4. 段落高亮显示（背景色 `#fff3cd`，边框 2px `#ffc107`）
  5. 高亮持续 3 秒后淡出（500ms 动画）
  6. 如目标段落不在当前章节，先切换章节再滚动

**联动反馈**：
- 滚动过程中，目标段落提前显示"即将跳转"提示（淡入动画）
- 跳转完成后，显示"已定位到相关段落"提示（2 秒后自动消失）
- 支持"返回"按钮，回到跳转前的位置

**错误处理**：
- 如目标段落不存在，显示错误提示："未找到相关段落"
- 如目标章节未加载，显示加载提示并异步加载章节

### 5.4 LLM 阅读助手

#### 5.4.1 提问入口
**入口位置**：
- 悬浮按钮：右下角固定位置，圆形按钮（直径 56px），蓝色背景，图标为"💬"
- 侧栏 tab：右侧信息面板的"问答"标签页
- 两种入口功能一致，悬浮按钮点击后展开侧栏问答面板

**对话界面**：
- 布局：聊天式界面，消息列表 + 输入框
- 消息列表：高度自适应，最大高度 500px，超出可滚动
- 输入框：多行文本输入（最多 10 行），支持 Ctrl+Enter 发送，Enter 换行
- 发送按钮：输入框右侧，有内容时高亮，无内容时禁用

**对话状态**：
- 初始状态：显示欢迎语和 3 条建议问题
- 提问中：显示"思考中..."动画，禁用输入框
- 回答中：显示流式输出（逐字显示，模拟打字效果）
- 回答完成：显示引用标签和操作按钮

#### 5.4.2 上下文构建
**上下文组成**（按优先级排序）：
1. **当前段落文本**：完整段落内容，包含段落 ID
2. **相关人物摘要**：当前段落涉及的人物，每人 50 字摘要（姓名、身份、关键信息）
3. **相关地点摘要**：当前段落涉及的地点，每地 30 字摘要（名称、位置、重要性）
4. **章节背景**：章节标题、时间范围、主要事件概述（100 字）
5. **对话历史**：最近 3 轮对话（问题+回答），用于多轮对话理解

**上下文格式**（发送给 LLM）：
```
你是一位历史阅读助手，正在帮助用户理解《史记·高祖本纪》。

当前阅读段落：
[段落文本内容]
段落ID: chapter_1_paragraph_3

相关人物：
- 刘邦：汉朝开国皇帝，沛县人，...
- 萧何：刘邦的重要谋士，...

相关地点：
- 沛县：刘邦的故乡，位于...

章节背景：
《高祖本纪》记录了刘邦从起兵到建立汉朝的过程，时间跨度...

对话历史：
用户：刘邦为什么信任萧何？
助手：刘邦与萧何是沛县同乡，...

用户问题：[用户输入的问题]
```

**上下文长度控制**：
- 总长度限制：4000 tokens（GPT-3.5）或 8000 tokens（GPT-4）
- 超出时：优先保留当前段落和对话历史，人物/地点摘要压缩至 30 字/人
- 章节背景始终保留，但压缩至 50 字

#### 5.4.3 回答展现
**回答格式**：
- 文本内容：Markdown 格式支持，包括**粗体**、*斜体*、列表、链接
- 引用标签：自动识别回答中提及的段落/人物/地点，添加引用标签
  - 格式：`[引用：高祖本纪·第 3 段]`，点击可跳转到对应段落
  - 人物引用：`[人物：刘邦]`，点击打开人物卡片
  - 地点引用：`[地点：沛县]`，点击在地图上查看
- 操作按钮：
  - "继续追问"：聚焦输入框，预填充"关于上面的回答，我还想了解..."
  - "复制回答"：复制完整回答文本到剪贴板
  - "分享"：生成分享链接（如有分享功能）

**回答样式**：
- 用户消息：右侧对齐，蓝色背景，白色文字
- 助手消息：左侧对齐，灰色背景，黑色文字
- 引用标签：浅黄色背景，可点击，hover 时显示完整引用信息
- 代码块：如有代码示例，使用代码块样式（等宽字体，灰色背景）

**流式输出**：
- 使用 Server-Sent Events (SSE) 或 WebSocket 实现流式传输
- 显示效果：逐字显示，速度约 30 字/秒
- 支持中断：用户可点击"停止"按钮中断生成

#### 5.4.4 建议问题
**生成时机**：
- 进入问答面板时：基于当前段落自动生成 3 条建议
- 回答完成后：基于回答内容生成 3 条相关追问
- 切换段落时：重新生成基于新段落的建议

**生成规则**：
- 基于段落热点：提取段落中的关键人物、地点、事件，生成"XX 是谁？"、"XX 在哪里？"等问题
- 基于常见问题模板：
  - "XX 和 XX 是什么关系？"
  - "为什么 XX 会这样做？"
  - "XX 事件发生在哪里？"
  - "XX 在历史上有什么影响？"
- 基于 LLM 生成：调用 LLM 生成 3 条自然语言问题（可选，MVP 可先用模板）

**建议问题展示**：
- 位置：输入框上方，3 个按钮横向排列
- 样式：浅蓝色背景，圆角，hover 时加深
- 交互：点击后自动填充到输入框并发送

#### 5.4.5 安全与校对
**回答免责声明**：
- 每个回答底部显示："⚠️ 本回答由 AI 生成，仅供参考。如有疑问，请查阅原始史料。"
- 字体：10px，灰色

**反馈机制**：
- 反馈按钮：每个回答下方显示"👍 有用"和"👎 有误"按钮
- 点击"有误"后：
  1. 弹出反馈表单：
     ```
     ┌─────────────────────────┐
     │ 反馈问题                 │
     │ ─────────────────────── │
     │ 问题描述：[多行输入]     │
     │ ─────────────────────── │
     │ 正确信息：[可选]         │
     │ ─────────────────────── │
     │ 联系方式：[可选]         │
     │ ─────────────────────── │
     │ [提交] [取消]            │
     └─────────────────────────┘
     ```
  2. 提交后记录：问题ID、用户问题、AI回答、用户反馈、时间戳
  3. 显示感谢提示："感谢反馈，我们会尽快核实并改进。"

**反馈数据存储**：
- 存储到数据库或日志文件
- 定期（每周）汇总反馈，用于改进提示词和数据质量

### 5.5 数据准备流程（LLM 批量提取 + 人工 Review）

#### 5.5.0 数据获取架构说明

**核心策略：预构建知识库 + LLM 实时增强**

**预构建知识库**（结构化数据，快速查询）：
- **存储内容**：人物节点、关系边、地点节点、事件节点、段落关联
- **数据来源**：LLM 批量提取 + 人工 review（见 5.5.1-5.5.5）
- **查询性能**：数据库查询 <50ms，关系图谱构建 <500ms
- **使用场景**：
  - 人物列表加载
  - 关系图谱渲染
  - 地图标记显示
  - 段落关联信息（hover 高亮）

**LLM 实时增强**（按需生成，灵活补充）：
- **使用场景**：
  - 用户问答（结合知识库 + 当前段落）
  - 上下文摘要生成（可缓存）
  - 建议问题生成（可缓存）
- **性能优化**：
  - 上下文摘要缓存：相同段落只生成一次，缓存 24 小时
  - 建议问题缓存：相同段落缓存，切换段落时复用
  - 流式输出：降低用户感知延迟

**混合工作流示例**：
- **场景 A：用户打开人物面板**
  - 查询预构建数据库 → 响应时间 <100ms ✅
- **场景 B：用户提问"刘邦为什么信任萧何？"**
  - 查询预构建数据（人物、关系、段落）→ <150ms
  - 构建上下文 → <10ms
  - 调用 LLM → 2-4 秒
  - 总响应时间：2-4 秒（主要是 LLM）
- **场景 C：用户 hover 人物名称**
  - 查询预构建数据 → <50ms ✅
  - 无需 LLM，即时显示

**成本对比**：
- 预构建方案：一次性成本（LLM 提取 + 人工 review），运行时成本几乎为 0
- 纯 LLM 实时方案：每次查询 $0.01-0.3，1000 次/天 ≈ $10-300/天
- 混合方案：预构建 + LLM 仅用于问答（可缓存），预计 $5-20/天

#### 5.5.1 整体流程
**工作流程**：
```
原始文本 → LLM 批量提取 → JSON 输出 → Review 工具 → 修正 → 导入数据库
```

**适用场景**：
- MVP 阶段：单人快速构建初始知识库
- 扩展阶段：批量处理新章节数据
- 数据更新：补充遗漏的人物/关系/地点

**预计工作量**（单人，1 章）：
- LLM 提取：10-20 分钟（脚本运行）
- 人工 Review：3.5-5 小时（30-40 人物 + 50-80 关系 + 20-30 地点）
- 总计：约 1 个工作日

#### 5.5.2 LLM 批量提取

**工具要求**：
- 脚本语言：Python 或 Node.js
- LLM 模型：GPT-4（推荐）或 Claude-3
- 输出格式：JSON 文件

**提取任务**：
1. **人物提取**：从章节文本中提取所有人物及其基本信息
2. **关系提取**：基于人物列表和文本，提取人物间关系
3. **地点提取**：提取所有地理名称及其信息
4. **事件提取**（可选）：提取关键历史事件

**人物提取提示词模板**：
```
你是一位历史数据提取专家。请从以下《史记·高祖本纪》文本中提取所有人物信息。

要求：
1. 提取所有出现的人物（包括主要和次要人物）
2. 对于每个人物，提取以下信息：
   - 姓名（标准名称，使用最常见的称呼）
   - 别称/称号（数组，如["汉高祖", "刘季", "沛公"]）
   - 角色定位（从以下选择：君主/谋士/将领/文臣/武将/外戚/宦官/其他）
   - 阵营（从以下选择：汉/楚/中立/其他）
   - 生卒年代（格式："公元前256年-公元前195年"，如不确定写"不详"）
   - 简介（100-200字，基于文本内容，客观描述）
   - 首次出现的段落编号（如"第3段"）

3. 输出格式：JSON 数组，每个对象包含上述字段
4. 确保信息准确，不要编造不存在的内容

文本内容：
[章节完整文本]

请输出 JSON 格式，不要包含任何其他文字说明。
```

**关系提取提示词模板**：
```
基于以下人物列表和章节文本，提取人物间的关系。

人物列表：
[已提取的人物 JSON 数组]

章节文本：
[章节完整文本]

要求：
1. 识别所有人物对之间的关系（双向关系只记录一次，以主要关系方向为准）
2. 关系类型（从以下选择）：
   - 盟友：政治或军事上的合作关系
   - 敌对：政治或军事上的对立关系
   - 上下级：明确的等级关系（source 是 target 的上司）
   - 族亲：家族血缘关系
   - 师徒：师生关系
   - 其他：其他类型的关系

3. 对于每个关系，提供：
   - 源人物姓名（sourceName）
   - 目标人物姓名（targetName）
   - 关系类型（type）
   - 关系描述（50-100字，说明关系的性质和演变过程）
   - 参考段落编号（数组，如["第5段", "第12段"]）

4. 输出格式：JSON 数组

请确保关系描述准确，基于文本内容，不要推测。
```

**地点提取提示词模板**：
```
从以下文本中提取所有地点信息。

要求：
1. 提取所有地理名称（城池、战场、河流、山脉、地区等）
2. 对于每个地点，提供：
   - 历史名称（name）
   - 现代地理映射（modernName，格式："今XX省XX市XX县"，如无法确定写"待查"）
   - 地点类型（type，从以下选择：城池/战场/河流/山脉/地区/其他）
   - 描述（50-100字，说明地点的重要性和历史背景）
   - 首次出现的段落编号（firstParagraph）

3. 注意：
   - 如果同一地点多次出现，只记录一次
   - 优先使用最常用的名称
   - 现代地理映射要尽可能准确

4. 输出格式：JSON 数组

文本内容：
[章节完整文本]
```

**提取脚本结构**（Python 示例）：
```python
import json
import openai
from typing import List, Dict

def extract_persons(chapter_text: str) -> List[Dict]:
    """提取人物信息"""
    prompt = f"""
    [人物提取提示词]
    {chapter_text}
    """
    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.3  # 降低随机性
    )
    return json.loads(response.choices[0].message.content)

def extract_relationships(persons: List[Dict], chapter_text: str) -> List[Dict]:
    """提取关系信息"""
    # 类似实现
    pass

def extract_places(chapter_text: str) -> List[Dict]:
    """提取地点信息"""
    # 类似实现
    pass

# 主流程
if __name__ == "__main__":
    chapter_text = open("shiji_gaozu.txt", "r", encoding="utf-8").read()
    
    persons = extract_persons(chapter_text)
    with open("extracted_persons.json", "w", encoding="utf-8") as f:
        json.dump(persons, f, ensure_ascii=False, indent=2)
    
    relationships = extract_relationships(persons, chapter_text)
    with open("extracted_relationships.json", "w", encoding="utf-8") as f:
        json.dump(relationships, f, ensure_ascii=False, indent=2)
    
    places = extract_places(chapter_text)
    with open("extracted_places.json", "w", encoding="utf-8") as f:
        json.dump(places, f, ensure_ascii=False, indent=2)
    
    print("提取完成！请检查 extracted_*.json 文件")
```

**输出文件格式**：
- `extracted_persons.json`：人物数组
- `extracted_relationships.json`：关系数组
- `extracted_places.json`：地点数组

#### 5.5.3 Review 工具（管理后台模块）

**功能定位**：
- 管理后台的核心模块之一
- 用于逐项检查、修正 LLM 提取的数据
- 支持批量操作和状态管理
- 与内容管理模块集成，统一工作流

**Review 界面设计**（Web 版）：

**人物 Review 卡片**：
```
┌─────────────────────────────────────────┐
│ 人物 #1/35                              │
│ ─────────────────────────────────────── │
│                                         │
│ [原始数据] (LLM 提取)                   │
│ ┌─────────────────────────────────────┐ │
│ │ 姓名: 刘邦                           │ │
│ │ 别称: [汉高祖, 刘季, 沛公]           │ │
│ │ 角色: 君主                           │ │
│ │ 阵营: 汉                             │ │
│ │ 生卒: 公元前256年-公元前195年        │ │
│ │ 简介: [LLM 生成的文本...]            │ │
│ │ 首次出现: 第1段                      │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ [修正数据] (可编辑)                     │
│ ┌─────────────────────────────────────┐ │
│ │ 姓名: [刘邦]                         │ │
│ │ 别称: [汉高祖, 刘季, 沛公] [编辑]    │ │
│ │ 角色: [君主 ▼]                       │ │
│ │ 阵营: [汉 ▼]                         │ │
│ │ 生卒: [公元前256年] - [公元前195年] │ │
│ │ 简介: [多行文本输入框]               │ │
│ │ 首次出现: [第1段]                    │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ [操作]                                  │
│ [✓ 通过] [✗ 拒绝] [✏ 修改] [💾 保存]   │
│                                         │
│ [审核备注]                              │
│ [___________________________________]   │
└─────────────────────────────────────────┘
```

**关系 Review 卡片**：
```
┌─────────────────────────────────────────┐
│ 关系 #1/60                              │
│ ─────────────────────────────────────── │
│                                         │
│ 源人物: 刘邦 → 目标人物: 萧何           │
│                                         │
│ [原始数据]                              │
│ 关系类型: 上下级                        │
│ 关系描述: [LLM 生成的描述...]           │
│ 参考段落: [第5段, 第12段]               │
│                                         │
│ [修正数据]                              │
│ 关系类型: [上下级 ▼]                   │
│ 关系描述: [可编辑文本]                  │
│ 参考段落: [第5段, 第12段] [编辑]        │
│                                         │
│ [操作] [✓ 通过] [✗ 拒绝] [✏ 修改]      │
└─────────────────────────────────────────┘
```

**Review 工作流**：
1. **导入提取结果**：
   - 上传 `extracted_*.json` 文件
   - 系统解析并显示待 review 列表

2. **逐项检查**：
   - 显示 LLM 提取的原始数据
   - 对比原文验证准确性
   - 修正错误字段（姓名拼写、角色分类、阵营归属等）
   - 补充缺失信息（如地点坐标、人物画像链接）

3. **状态管理**：
   - `pending`：待审核
   - `approved`：已通过，可导入数据库
   - `rejected`：已拒绝，记录原因
   - `modified`：已修改，保存修正后的数据

4. **批量操作**：
   - 批量通过：选择多个项目，一键标记为"通过"
   - 批量拒绝：选择多个项目，标记为"拒绝"并记录原因
   - 导出修正数据：导出所有已审核的数据为 JSON

5. **质量检查清单**：
   - 人物：姓名拼写正确、角色分类准确、阵营归属正确、简介客观
   - 关系：关系类型准确、描述合理、参考段落正确
   - 地点：现代地理映射准确、坐标正确（如已查证）

#### 5.5.4 优化策略

**策略 1：分段提取**
- 不要一次性处理整章文本
- 按段落或事件分组提取（如每 10 段一组）
- 每段提取后立即 review，发现问题及时调整提示词

**策略 2：迭代优化提示词**
- 第一轮提取后，分析常见错误类型
- 调整提示词，加入错误示例和纠正说明
- 重新提取，提高准确率

**策略 3：多模型对比**（可选）
- 同时使用 GPT-4 和 Claude-3 提取
- 对比结果，选择更准确的版本
- 不一致的地方重点 review

**策略 4：验证检查清单**
- **人物验证**：
  - [ ] 姓名拼写正确（对比原文）
  - [ ] 角色分类准确（君主/谋士/将领等）
  - [ ] 阵营归属正确（汉/楚/中立）
  - [ ] 生卒年代合理（如有）
  - [ ] 简介客观，无主观判断

- **关系验证**：
  - [ ] 关系类型准确（盟友/敌对/上下级等）
  - [ ] 关系描述合理，有文本依据
  - [ ] 参考段落正确
  - [ ] 双向关系只记录一次

- **地点验证**：
  - [ ] 现代地理映射准确（需查证）
  - [ ] 坐标正确（如已查证）
  - [ ] 地点类型准确（城池/战场/河流等）

#### 5.5.5 数据导入

**导入流程**：
1. Review 完成后，导出已审核的数据（JSON 格式）
2. 在内容管理后台，使用"批量导入"功能
3. 系统验证数据格式和必填字段
4. 导入数据库，标记为"已发布"状态
5. 前端立即生效

**数据格式要求**：
- 必须符合 spec 6.2、6.3 中定义的数据结构
- 必填字段：ID、姓名/名称、简介/描述
- ID 自动生成或手动指定（需唯一）

### 5.6 管理后台设计

#### 5.6.0 整体架构

**定位**：
- 统一的管理后台，整合数据准备、内容管理、数据导入等功能
- 仅管理员可访问，需身份验证
- MVP 阶段：简易版本，满足核心需求

**功能模块**：
1. **数据准备模块**：LLM 提取结果 Review、批量导入
2. **内容管理模块**：节点编辑、关系管理、版本控制
3. **系统管理模块**：用户管理（如需要）、数据备份、日志查看

**技术实现**：
- 路由：`/admin`（需登录）
- 前端：独立的管理后台页面（可与主应用分离或集成）
- 后端：管理 API（`/api/admin/*`），需权限验证

#### 5.6.1 身份验证与权限

**登录机制**（MVP 简化版）：
- 方式 1：硬编码密码（环境变量）
  - 访问 `/admin` 时弹出登录框
  - 输入密码后，设置 session 或 token
  - 后续请求携带认证信息

- 方式 2：简单用户表（推荐）
  - 数据库存储管理员账号（用户名 + 密码哈希）
  - 支持多管理员（如需要）
  - 密码强度要求：至少 8 位，包含字母和数字

**权限控制**：
- 所有 `/api/admin/*` 接口需验证身份
- 前端路由守卫：未登录自动跳转到登录页
- Session 过期：30 分钟无操作自动登出

**安全措施**：
- 密码使用 bcrypt 等加密存储
- API 请求使用 HTTPS（生产环境）
- 防止 CSRF 攻击（token 验证）
- 操作日志：记录所有数据修改操作

#### 5.6.2 管理后台布局

**整体布局**：
```
┌─────────────────────────────────────────────────────┐
│ [Logo] 管理后台                    [用户名] [退出]   │
├──────────┬──────────────────────────────────────────┤
│          │                                          │
│ 侧边栏   │  主内容区                                │
│          │                                          │
│ • 数据准备│  [当前模块内容]                          │
│   - Review│                                         │
│   - 批量导入│                                        │
│          │                                          │
│ • 内容管理│                                         │
│   - 人物管理│                                        │
│   - 关系管理│                                        │
│   - 地点管理│                                        │
│   - 事件管理│                                        │
│          │                                          │
│ • 系统管理│                                         │
│   - 数据备份│                                        │
│   - 操作日志│                                        │
│          │                                          │
└──────────┴──────────────────────────────────────────┘
```

**侧边栏导航**：
- 固定左侧，宽度 200px
- 支持折叠（点击收起/展开）
- 当前模块高亮显示
- 响应式：移动端自动折叠为抽屉式

**主内容区**：
- 右侧自适应宽度
- 支持多标签页（如同时打开多个编辑表单）
- 顶部面包屑导航（如：数据准备 > Review > 人物）

#### 5.6.3 数据准备模块

**功能入口**：
- 侧边栏"数据准备"菜单
- 子菜单：Review、批量导入

**Review 子模块**：
- **列表视图**：
  - 显示所有待 review 的数据（人物/关系/地点）
  - 支持筛选：按类型、状态、来源（LLM 提取/手动录入）
  - 支持搜索：按名称/ID 搜索
  - 列表项显示：名称、状态、来源、创建时间、操作按钮

- **详情视图**：
  - 点击列表项进入详情页
  - 显示原始数据（LLM 提取）和修正数据（可编辑）
  - 操作按钮：通过/拒绝/保存修改
  - 审核备注输入框

- **批量操作**：
  - 选择多个项目，批量通过/拒绝
  - 批量导出为 JSON
  - 批量删除（需确认）

**批量导入子模块**：
- **上传界面**：
  - 支持拖拽上传或点击选择文件
  - 支持文件类型：JSON（`extracted_*.json`）
  - 上传前预览：显示文件内容摘要（记录数、字段等）

- **导入配置**：
  - 选择导入类型：人物/关系/地点/事件
  - 导入模式：新增/更新/跳过已存在
  - 默认状态：导入后标记为"pending"（待审核）

- **导入结果**：
  - 显示导入统计：成功/失败数量
  - 失败原因：显示错误详情（格式错误、必填字段缺失等）
  - 导入日志：记录导入时间、文件来源、操作人

#### 5.6.4 内容管理模块

**功能入口**：
- 侧边栏"内容管理"菜单
- 子菜单：人物管理、关系管理、地点管理、事件管理

**统一列表视图**：
- 表格显示：ID、名称、状态、创建时间、更新时间、操作
- 支持筛选：按状态、类型、创建时间
- 支持搜索：按名称/ID
- 支持排序：按创建时间、更新时间、名称
- 分页：每页 20 条，支持跳转

**编辑视图**：
- 点击"编辑"进入详情页
- 表单字段根据类型动态显示（人物/关系/地点/事件）
- 支持保存为草稿或直接发布
- 支持删除（需确认）

**批量操作**：
- 批量选择：支持全选/反选
- 批量修改状态：批量发布/下架/删除
- 批量导出：导出选中项为 JSON

#### 5.6.5 系统管理模块

**数据备份**：
- 手动备份：点击"立即备份"，生成数据快照
- 自动备份：每日自动备份（可配置）
- 备份列表：显示所有备份记录（时间、大小、操作人）
- 恢复功能：选择备份文件，确认后恢复

**操作日志**：
- 记录所有数据修改操作
- 日志字段：时间、操作人、操作类型（创建/更新/删除）、目标（人物/关系等）、详情
- 支持筛选：按时间范围、操作人、操作类型
- 支持搜索：按目标名称/ID
- 导出日志：导出为 CSV 或 JSON

**系统设置**（可选）：
- LLM API 配置：API Key、模型选择、温度参数
- 缓存设置：缓存过期时间、清理缓存
- 通知设置：数据导入完成通知、错误告警

#### 5.6.6 管理后台 API

**认证相关**：
- `POST /api/admin/login`：管理员登录
- `POST /api/admin/logout`：退出登录
- `GET /api/admin/me`：获取当前管理员信息

**数据准备相关**：
- `GET /api/admin/review/items`：获取待 review 列表
- `GET /api/admin/review/items/:id`：获取 review 详情
- `POST /api/admin/review/items/:id/approve`：通过审核
- `POST /api/admin/review/items/:id/reject`：拒绝审核
- `POST /api/admin/review/items/:id/update`：保存修改
- `POST /api/admin/import/batch`：批量导入

**内容管理相关**：
- `GET /api/admin/persons`：获取人物列表
- `GET /api/admin/persons/:id`：获取人物详情
- `POST /api/admin/persons`：创建人物
- `PUT /api/admin/persons/:id`：更新人物
- `DELETE /api/admin/persons/:id`：删除人物
- （关系/地点/事件类似）

**系统管理相关**：
- `POST /api/admin/backup`：创建备份
- `GET /api/admin/backups`：获取备份列表
- `POST /api/admin/restore`：恢复备份
- `GET /api/admin/logs`：获取操作日志

### 5.7 内容管理（节点编辑与管理）

> 注：此部分为内容管理的详细功能说明，管理后台界面设计见 5.6

#### 5.7.1 节点管理

**管理界面**：
- 入口：管理后台的"内容管理"模块（见 5.6.4）
- 界面设计：统一的管理后台布局（见 5.6.2）
- 功能：节点编辑、状态管理、批量操作

**节点状态管理**：
- `draft`：草稿状态，不影响前端展示
- `pending`：待审核（从 LLM 提取导入后）
- `approved`：已审核通过
- `published`：已发布，前端可见
- `rejected`：已拒绝，记录拒绝原因

**状态筛选**：
- 列表支持按状态筛选（全部/草稿/待审核/已发布等）
- 不同状态用不同颜色标识（草稿-灰色、待审核-黄色、已发布-绿色）

**人物节点编辑**：
- 表单字段：
  ```
  ┌─────────────────────────┐
  │ 人物信息编辑             │
  │ ─────────────────────── │
  │ ID: [自动生成/手动输入]  │
  │ 姓名: [文本输入]         │
  │ 别称: [多行，每行一个]   │
  │ 角色定位: [下拉选择]     │
  │ 阵营: [单选]             │
  │ 生卒年代: [起-止]        │
  │ 简介: [多行文本，500字]  │
  │ 关键事件: [多行，每行一个事件ID]
  │ 画像链接: [URL输入]      │
  │ ─────────────────────── │
  │ [保存] [取消] [删除]     │
  └─────────────────────────┘
  ```
- 验证规则：
  - 姓名必填，长度 1-20 字
  - 简介必填，长度 10-500 字
  - ID 唯一性检查
- 保存格式：JSON 文件或数据库记录

**地点节点编辑**：
- 表单字段：ID、名称、现代地理映射、经纬度（lng, lat）、所属势力、相关事件ID列表、描述
- 地图选择：支持在地图上点击选择坐标（如有地图组件）
- 验证：经纬度范围检查（中国范围：lng 73-135, lat 18-54）

**事件节点编辑**：
- 表单字段：ID、事件名称、起止时间（支持农历输入）、地点ID、参与人物ID列表、简述、相关段落ID列表
- 时间输入：支持"公元前 XX 年"格式，自动转换为统一时间戳

**批量操作**：
- **批量导入**：
  - 支持导入 LLM 提取的 JSON 文件（`extracted_persons.json` 等）
  - 导入前验证数据格式和必填字段
  - 支持增量导入（跳过已存在的 ID）
  - 导入后自动标记为"已发布"状态
  - 导入日志：记录导入时间、文件来源、导入数量

- **批量导出**：
  - 导出当前所有节点为 JSON 文件
  - 支持按类型导出（只导出人物/地点/事件）
  - 支持导出指定章节的数据

- **批量删除**：
  - 支持批量选择并删除
  - 删除前需确认（防止误操作）
  - 删除后记录日志

#### 5.7.2 关系管理
**关系编辑界面**：
- 入口：节点管理页面中的"关系"标签
- 关系创建：
  ```
  ┌─────────────────────────┐
  │ 创建关系                 │
  │ ─────────────────────── │
  │ 源节点: [下拉选择人物]    │
  │ 目标节点: [下拉选择人物]  │
  │ 关系类型: [下拉选择]     │
  │ 关系描述: [多行文本]     │
  │ 参考章节: [文本输入]     │
  │ 可信等级: [1-5星选择]    │
  │ ─────────────────────── │
  │ [保存] [取消]            │
  └─────────────────────────┘
  ```
- 关系列表：表格显示所有关系，支持筛选、搜索、编辑、删除

**重复关系检查**：
- 保存前检查：是否存在相同的 sourceId + targetId + 关系类型
- 如存在：提示"关系已存在，是否更新？"，或允许创建多条不同描述的关系

**关系可视化预览**：
- 在关系编辑页面，显示关系图谱预览
- 实时更新：编辑关系后，图谱自动刷新

#### 5.7.3 版本控制
**数据快照机制**：
- 触发时机：每次发布前（手动触发或 CI/CD 自动）
- 快照内容：所有节点数据、关系数据、章节文本的完整副本
- 存储格式：JSON 文件，命名规则：`snapshot_YYYYMMDD_HHMMSS.json`
- 存储位置：`/data/snapshots/` 目录或数据库版本表

**回滚流程**：
1. 在管理后台选择要回滚的快照
2. 预览快照内容（显示变更摘要）
3. 确认回滚，系统恢复数据
4. 记录回滚日志（时间、操作人、原因）

**版本对比**：
- 支持对比两个快照的差异
- 显示新增/删除/修改的节点和关系
- 以表格或可视化方式展示差异

#### 5.7.4 内容校验流程
**编辑流程**：
1. **录入阶段**：
   - 编辑人员在管理后台录入节点和关系
   - 保存为"草稿"状态（`status: 'draft'`）
   - 草稿数据不影响前端展示

2. **审校阶段**：
   - 审校人员查看草稿列表
   - 逐项检查：准确性、完整性、格式规范
   - 可添加审校备注
   - 标记为"通过"或"需修改"

3. **发布阶段**：
   - 通过审校的数据标记为"已发布"（`status: 'published'`）
   - 发布后立即生效，前端可读取
   - 生成发布日志

**MVP 简化流程**（使用 Git PR）：
- 数据文件存储在 Git 仓库
- 编辑人员创建分支，修改 JSON 文件
- 提交 PR，审校人员在 PR 中评论
- 合并 PR 后，自动部署更新数据

**数据质量检查**：
- 自动检查：必填字段、格式规范、ID 唯一性、关系完整性（节点是否存在）
- 手动检查：内容准确性、历史事实正确性（需人工）

---

## 6. 数据与内容要求

### 6.1 文本与元数据

#### 6.1.1 章节数据结构
```typescript
interface Chapter {
  id: string;                    // 格式: "chapter_1", 唯一标识
  bookId: string;                // 书籍ID, 如 "shiji"
  title: string;                 // 章节标题, 如 "高祖本纪"
  summary: string;               // 章节简介, 100-200字
  order: number;                 // 章节顺序, 从1开始
  totalParagraphs: number;       // 段落总数
  timeRange?: {                  // 时间范围（可选）
    start: string;               // 如 "公元前256年"
    end: string;                 // 如 "公元前195年"
  };
  createdAt: string;            // ISO 8601 时间戳
  updatedAt: string;
}
```

#### 6.1.2 段落数据结构
```typescript
interface Paragraph {
  id: string;                    // 格式: "chapter_1_paragraph_3", 唯一标识
  chapterId: string;             // 所属章节ID
  order: number;                  // 段落顺序, 从1开始
  text: string;                   // 段落原文, 支持换行符
  annotations: Annotation[];      // 行间注释数组
  relatedPersons: string[];       // 相关人物ID列表
  relatedPlaces: string[];        // 相关地点ID列表
  relatedEvents: string[];        // 相关事件ID列表
  createdAt: string;
  updatedAt: string;
}

interface Annotation {
  id: string;                     // 注释ID
  targetText: string;             // 被注释的文本（原文中的片段）
  explanation: string;             // 注释内容, 最多60字
  position: number;                // 在段落中的位置（字符索引）
}
```

**示例数据**：
```json
{
  "id": "chapter_1_paragraph_3",
  "chapterId": "chapter_1",
  "order": 3,
  "text": "高祖，沛丰邑中阳里人也，姓刘氏，字季。父曰太公，母曰刘媪。",
  "annotations": [
    {
      "id": "ann_1",
      "targetText": "沛丰邑",
      "explanation": "沛县丰邑，今江苏省丰县",
      "position": 3
    }
  ],
  "relatedPersons": ["person_liubang", "person_taigong", "person_liuao"],
  "relatedPlaces": ["place_peixian"],
  "relatedEvents": []
}
```

#### 6.1.3 文本来源要求
- **版权合规**：使用公开版权版本（如古籍公共版权）或自有 OCR 成果
- **准确性**：文本需经过校对，错误率 < 0.1%
- **格式规范**：统一使用 UTF-8 编码，段落间用换行符分隔
- **存储方式**：JSON 文件或数据库表，支持版本管理

### 6.2 人物 / 关系数据

#### 6.2.1 人物数据结构
```typescript
interface Person {
  id: string;                     // 格式: "person_liubang", 唯一标识
  name: string;                   // 姓名, 如 "刘邦"
  aliases: string[];              // 别称数组, 如 ["汉高祖", "刘季"]
  role: PersonRole;               // 角色定位, 枚举值
  faction: Faction;               // 阵营, 枚举值
  birthYear?: string;             // 生年, 如 "公元前256年"
  deathYear?: string;             // 卒年, 如 "公元前195年"
  activePeriod?: {                // 活跃年代（如生卒不详）
    start: string;
    end: string;
  };
  biography: string;               // 简介, 200-500字
  keyEvents: string[];            // 关键事件ID列表
  portraitUrl?: string;           // 画像链接（可选）
  firstAppearance: {              // 首次出现位置
    chapterId: string;
    paragraphId: string;
  };
  createdAt: string;
  updatedAt: string;
}

enum PersonRole {
  MONARCH = "君主",              // 君主
  ADVISOR = "谋士",              // 谋士
  GENERAL = "将领",              // 将领
  CIVIL_OFFICIAL = "文臣",       // 文臣
  MILITARY_OFFICIAL = "武将",    // 武将
  RELATIVE = "外戚",             // 外戚
  EUNUCH = "宦官",              // 宦官
  OTHER = "其他"                 // 其他
}

enum Faction {
  HAN = "汉",                    // 汉
  CHU = "楚",                    // 楚
  NEUTRAL = "中立",              // 中立
  OTHER = "其他"                 // 其他
}
```

**示例数据**：
```json
{
  "id": "person_liubang",
  "name": "刘邦",
  "aliases": ["汉高祖", "刘季", "沛公"],
  "role": "君主",
  "faction": "汉",
  "birthYear": "公元前256年",
  "deathYear": "公元前195年",
  "biography": "汉朝开国皇帝，沛县丰邑人。起兵反秦，后与项羽争霸，建立汉朝。",
  "keyEvents": ["event_1", "event_2"],
  "portraitUrl": "https://example.com/liubang.jpg",
  "firstAppearance": {
    "chapterId": "chapter_1",
    "paragraphId": "chapter_1_paragraph_1"
  }
}
```

#### 6.2.2 关系数据结构
```typescript
interface Relationship {
  id: string;                     // 格式: "rel_liubang_xiaohe", 唯一标识
  sourceId: string;               // 源人物ID
  targetId: string;               // 目标人物ID
  type: RelationshipType;        // 关系类型, 枚举值
  description: string;            // 关系描述, 100-300字
  referenceChapters: string[];    // 参考章节ID列表
  confidence: number;             // 可信等级, 1-5 (5最可信)
  timeRange?: {                   // 关系时间范围（可选）
    start: string;
    end: string;
  };
  createdAt: string;
  updatedAt: string;
}

enum RelationshipType {
  ALLY = "盟友",                 // 盟友
  ENEMY = "敌对",                // 敌对
  SUPERIOR = "上下级",           // 上下级（source是target的上司）
  SUBORDINATE = "下级",          // 下级（source是target的下属）
  KINSHIP = "族亲",              // 族亲
  TEACHER_STUDENT = "师徒",      // 师徒
  OTHER = "其他"                 // 其他
}
```

**示例数据**：
```json
{
  "id": "rel_liubang_xiaohe",
  "sourceId": "person_liubang",
  "targetId": "person_xiaohe",
  "type": "上下级",
  "description": "刘邦与萧何是沛县同乡，萧何是刘邦的重要谋士和丞相，关系密切。",
  "referenceChapters": ["chapter_1", "chapter_2"],
  "confidence": 5,
  "timeRange": {
    "start": "公元前209年",
    "end": "公元前195年"
  }
}
```

#### 6.2.3 数据覆盖要求
- **人物覆盖**：MVP 章节内 ≥90% 的主要人物（预计 30-40 个）
- **关系覆盖**：至少覆盖 3 类关系（盟友、敌对、上下级），每个主要人物至少 2-3 条关系
- **数据质量**：所有人物和关系需有明确的史料来源，可信等级 ≥3

### 6.3 地理 / 时间数据

#### 6.3.1 地点数据结构
```typescript
interface Place {
  id: string;                     // 格式: "place_peixian", 唯一标识
  name: string;                   // 历史名称, 如 "沛县"
  modernName: string;             // 现代地理名称, 如 "江苏省徐州市沛县"
  coordinates: {                  // 经纬度坐标
    lng: number;                  // 经度, 范围 73-135
    lat: number;                  // 纬度, 范围 18-54
  };
  type: PlaceType;                // 地点类型, 枚举值
  faction?: Faction;              // 所属势力（可选）
  relatedEvents: string[];        // 相关事件ID列表
  description: string;            // 地点描述, 100-200字
  firstAppearance?: {             // 首次出现位置（可选）
    chapterId: string;
    paragraphId: string;
  };
  createdAt: string;
  updatedAt: string;
}

enum PlaceType {
  CITY = "城池",                 // 城池
  BATTLEFIELD = "战场",          // 战场
  RIVER = "河流",                // 河流
  MOUNTAIN = "山脉",             // 山脉
  REGION = "地区",               // 地区
  OTHER = "其他"                 // 其他
}
```

**示例数据**：
```json
{
  "id": "place_peixian",
  "name": "沛县",
  "modernName": "江苏省徐州市沛县",
  "coordinates": {
    "lng": 116.937,
    "lat": 34.729
  },
  "type": "城池",
  "faction": "汉",
  "relatedEvents": ["event_1", "event_2"],
  "description": "刘邦的故乡，位于今江苏省北部，是汉朝的重要发源地。"
}
```

#### 6.3.2 事件数据结构
```typescript
interface Event {
  id: string;                     // 格式: "event_hongmen", 唯一标识
  name: string;                   // 事件名称, 如 "鸿门宴"
  timeRange: {                    // 时间范围
    start: string;                // 开始时间, 如 "公元前206年12月"
    end?: string;                 // 结束时间（可选）
    lunarCalendar?: string;       // 农历（可选）
  };
  locationId: string;             // 地点ID
  participants: string[];         // 参与人物ID列表
  relatedParagraphs: string[];    // 相关段落ID列表
  summary: string;                // 事件简述, 100-300字
  type: EventType;                // 事件类型, 枚举值
  impact?: string;                // 影响描述（可选）
  createdAt: string;
  updatedAt: string;
}

enum EventType {
  BATTLE = "战役",               // 战役
  POLITICAL = "政治事件",        // 政治事件
  PERSONAL = "人物事件",         // 人物事件
  OTHER = "其他"                 // 其他
}
```

**示例数据**：
```json
{
  "id": "event_hongmen",
  "name": "鸿门宴",
  "timeRange": {
    "start": "公元前206年12月",
    "lunarCalendar": "汉元年十一月"
  },
  "locationId": "place_hongmen",
  "participants": ["person_liubang", "person_xiangyu", "person_zhangliang"],
  "relatedParagraphs": ["chapter_1_paragraph_15", "chapter_1_paragraph_16"],
  "summary": "项羽在鸿门设宴，意图除掉刘邦，但最终被张良等人化解危机。",
  "type": "政治事件",
  "impact": "标志着楚汉战争的转折点，刘邦得以保存实力。"
}
```

#### 6.3.3 地图底图要求
- **底图选择**：优先使用自绘历史地图底图（更符合历史背景）
- **备选方案**：使用 Leaflet + OpenStreetMap，但需自定义样式
- **标注层**：支持 GeoJSON 格式的标注层（地点标记、势力范围）
- **势力范围**：使用 GeoJSON Polygon，支持时间维度切换（如有数据）

---

## 7. API 接口定义

### 7.1 章节与段落接口

#### GET /api/chapters
获取章节列表

**请求参数**：
- 无

**响应示例**：
```json
{
  "code": 200,
  "data": [
    {
      "id": "chapter_1",
      "bookId": "shiji",
      "title": "高祖本纪",
      "summary": "记录刘邦从起兵到建立汉朝的过程",
      "order": 1,
      "totalParagraphs": 50,
      "readParagraphs": 15,
      "lastReadAt": "2024-01-15T10:30:00Z"
    }
  ]
}
```

#### GET /api/chapters/:chapterId
获取章节详情

**请求参数**：
- `chapterId` (path): 章节ID

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "id": "chapter_1",
    "title": "高祖本纪",
    "summary": "...",
    "paragraphs": [
      {
        "id": "chapter_1_paragraph_1",
        "order": 1,
        "text": "高祖，沛丰邑中阳里人也...",
        "annotations": [...],
        "relatedPersons": ["person_liubang"],
        "relatedPlaces": ["place_peixian"]
      }
    ]
  }
}
```

#### GET /api/chapters/:chapterId/paragraphs/:paragraphId
获取单个段落详情

**请求参数**：
- `chapterId` (path): 章节ID
- `paragraphId` (path): 段落ID

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "id": "chapter_1_paragraph_1",
    "text": "...",
    "annotations": [...],
    "relatedPersons": [...],
    "relatedPlaces": [...]
  }
}
```

### 7.2 人物与关系接口

#### GET /api/persons
获取人物列表

**请求参数**：
- `chapterId` (query, 可选): 筛选特定章节的人物
- `faction` (query, 可选): 筛选阵营
- `role` (query, 可选): 筛选角色类型
- `search` (query, 可选): 搜索关键词
- `page` (query, 可选): 页码，默认 1
- `pageSize` (query, 可选): 每页数量，默认 20

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "items": [...],
    "total": 35,
    "page": 1,
    "pageSize": 20
  }
}
```

#### GET /api/persons/:personId
获取人物详情

**请求参数**：
- `personId` (path): 人物ID

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "id": "person_liubang",
    "name": "刘邦",
    "aliases": ["汉高祖", "刘季"],
    "role": "君主",
    "faction": "汉",
    "biography": "...",
    "keyEvents": [...],
    "relationships": [
      {
        "id": "rel_1",
        "targetPerson": {...},
        "type": "上下级",
        "description": "..."
      }
    ]
  }
}
```

#### GET /api/relationships
获取关系列表

**请求参数**：
- `chapterId` (query, 可选): 筛选特定章节的关系
- `personId` (query, 可选): 筛选与特定人物相关的关系
- `type` (query, 可选): 筛选关系类型

**响应示例**：
```json
{
  "code": 200,
  "data": [
    {
      "id": "rel_liubang_xiaohe",
      "sourceId": "person_liubang",
      "targetId": "person_xiaohe",
      "type": "上下级",
      "description": "...",
      "sourcePerson": {...},
      "targetPerson": {...}
    }
  ]
}
```

#### GET /api/chapters/:chapterId/relationship-graph
获取章节关系图谱数据

**请求参数**：
- `chapterId` (path): 章节ID

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "nodes": [
      {
        "id": "person_liubang",
        "name": "刘邦",
        "faction": "汉",
        "role": "君主",
        "importance": "high"
      }
    ],
    "edges": [
      {
        "id": "rel_1",
        "source": "person_liubang",
        "target": "person_xiaohe",
        "type": "上下级",
        "weight": 5
      }
    ]
  }
}
```

### 7.3 地理与时间接口

#### GET /api/places
获取地点列表

**请求参数**：
- `chapterId` (query, 可选): 筛选特定章节的地点
- `type` (query, 可选): 筛选地点类型
- `faction` (query, 可选): 筛选所属势力

**响应示例**：
```json
{
  "code": 200,
  "data": [
    {
      "id": "place_peixian",
      "name": "沛县",
      "coordinates": {"lng": 116.937, "lat": 34.729},
      "type": "城池",
      "faction": "汉"
    }
  ]
}
```

#### GET /api/events
获取事件列表

**请求参数**：
- `chapterId` (query, 可选): 筛选特定章节的事件
- `timeRange` (query, 可选): 时间范围筛选，格式 "start,end"
- `locationId` (query, 可选): 筛选特定地点的事件
- `personId` (query, 可选): 筛选特定人物参与的事件

**响应示例**：
```json
{
  "code": 200,
  "data": [
    {
      "id": "event_hongmen",
      "name": "鸿门宴",
      "timeRange": {"start": "公元前206年12月"},
      "locationId": "place_hongmen",
      "participants": ["person_liubang", "person_xiangyu"],
      "summary": "..."
    }
  ]
}
```

#### GET /api/chapters/:chapterId/timeline
获取章节时间轴数据

**请求参数**：
- `chapterId` (path): 章节ID

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "timeRange": {
      "start": "公元前256年",
      "end": "公元前195年"
    },
    "events": [
      {
        "id": "event_1",
        "name": "事件名称",
        "time": "公元前206年",
        "type": "战役",
        "icon": "⚔️"
      }
    ]
  }
}
```

### 7.4 LLM 问答接口

#### POST /api/chat/ask
发送问题给 LLM

**请求体**：
```json
{
  "question": "刘邦为什么信任萧何？",
  "chapterId": "chapter_1",
  "paragraphId": "chapter_1_paragraph_3",
  "conversationId": "conv_123",  // 可选，用于多轮对话
  "context": {
    "includeHistory": true,      // 是否包含对话历史
    "maxContextLength": 4000      // 最大上下文长度
  }
}
```

**响应**（流式）：
```
data: {"type": "start", "conversationId": "conv_123"}

data: {"type": "token", "content": "刘邦"}

data: {"type": "token", "content": "与"}

data: {"type": "token", "content": "萧何"}

...

data: {"type": "end", "citations": ["chapter_1_paragraph_3"], "suggestedQuestions": ["...", "...", "..."]}
```

**错误响应**：
```json
{
  "code": 500,
  "message": "AI 服务暂时不可用，请稍后再试",
  "retryable": true
}
```

#### POST /api/chat/feedback
提交回答反馈

**请求体**：
```json
{
  "conversationId": "conv_123",
  "question": "原问题",
  "answer": "AI回答",
  "feedback": "negative",
  "description": "回答有误，正确信息是...",
  "contact": "user@example.com"  // 可选
}
```

**响应**：
```json
{
  "code": 200,
  "message": "感谢反馈"
}
```

### 7.5 用户进度接口

#### GET /api/progress
获取用户阅读进度（从 localStorage，无需 API，但可提供同步功能）

#### POST /api/progress
保存阅读进度（可选，MVP 可只用 localStorage）

**请求体**：
```json
{
  "chapterId": "chapter_1",
  "paragraphId": "chapter_1_paragraph_15",
  "scrollPosition": 1200
}
```

### 7.6 错误处理

**统一错误响应格式**：
```json
{
  "code": 400,
  "message": "错误描述",
  "details": {...}  // 可选，详细错误信息
}
```

**常见错误码**：
- `400`: 请求参数错误
- `404`: 资源不存在
- `500`: 服务器内部错误
- `503`: 服务暂时不可用（如 LLM 服务）

---

## 8. 非功能说明（核心范围）

### 8.1 性能要求

#### 8.1.1 加载性能
- **首屏加载时间**：
  - 目标：≤3 秒（3G 网络）
  - 静态资源（JS/CSS/图片）：<1MB，支持 Gzip 压缩
  - 章节数据：懒加载，首次只加载章节列表
  - 优化措施：代码分割、图片懒加载、CDN 加速

- **数据加载时间**：
  - 章节内容加载：≤1 秒（单章节，约 50 段）
  - 人物列表加载：≤500ms（30-40 个人物）
  - 关系图谱数据：≤800ms（包含节点和边）
  - 地图数据加载：≤1 秒（GeoJSON 数据）

#### 8.1.2 渲染性能
- **图谱渲染**：
  - 初始渲染节点数：≤50 个
  - 超过 50 个节点时：分段加载，先渲染核心节点，再异步加载次要节点
  - 动画帧率：≥30 FPS
  - 交互响应：拖拽、缩放延迟 ≤100ms

- **地图渲染**：
  - 标记数量：≤100 个，超过自动聚合
  - 缩放流畅度：≥30 FPS
  - 标记点击响应：≤200ms

- **文本渲染**：
  - 段落渲染：支持虚拟滚动，只渲染可见区域
  - 高亮更新：hover 高亮延迟 ≤200ms

#### 8.1.3 网络请求性能
- **LLM 请求**：
  - 首次响应时间（TTFB）：≤2 秒
  - 流式输出延迟：≤500ms（从请求到第一个 token）
  - 超时设置：10 秒，超时后自动重试一次
  - 失败降级：显示提示"AI 服务暂时不可用，请稍后再试"

- **API 请求**：
  - 所有 GET 请求：响应时间 ≤500ms（P95）
  - 请求重试：失败后自动重试 1 次，间隔 1 秒
  - 请求缓存：章节数据、人物列表等可缓存 1 小时

#### 8.1.4 存储性能
- **localStorage 使用**：
  - 存储大小限制：≤5MB（浏览器限制）
  - 存储内容：阅读进度、用户设置（字号、主题等）
  - 清理策略：超过 30 天未访问的进度数据自动清理

### 8.2 可用性与兼容性

#### 8.2.1 浏览器兼容性
- **桌面浏览器**（必须支持）：
  - Chrome 90+
  - Firefox 88+
  - Safari 14+
  - Edge 90+

- **移动浏览器**（可选，MVP 后实现）：
  - iOS Safari 14+
  - Chrome Mobile 90+

- **不支持的功能**：
  - IE 11 及以下：不兼容，显示升级提示

#### 8.2.2 屏幕尺寸适配
- **桌面端**（主要目标）：
  - 最小宽度：1366px
  - 推荐宽度：1920px
  - 布局：响应式，支持窗口缩放（80%-120%）

- **平板端**（可选）：
  - 宽度：768px - 1366px
  - 布局：简化版，侧栏可折叠为抽屉式

- **移动端**（可选，MVP 后实现）：
  - 宽度：<768px
  - 布局：单栏，信息面板为底部抽屉

#### 8.2.3 输入与交互
- **中文输入法**：
  - 支持所有主流输入法（搜狗、百度、微软拼音等）
  - 输入框支持 IME 输入，无延迟

- **复制功能**：
  - 支持复制原文段落（右键菜单或快捷键 Ctrl+C）
  - 复制时自动去除注释标记，只复制纯文本

- **快捷键支持**：
  - `↑/↓`: 滚动阅读区域
  - `←/→`: 切换信息面板标签
  - `Esc`: 关闭浮层卡片
  - `Ctrl+F`: 页面内搜索（浏览器原生）
  - `Ctrl+Enter`: 发送问题（问答面板）

- **无障碍支持**（MVP 后完善）：
  - 键盘导航：所有功能可通过键盘访问
  - 屏幕阅读器：基本支持（ARIA 标签）

### 8.3 内容质量与合规

#### 8.3.1 内容准确性
- **数据来源要求**：
  - 所有人物/事件描述需注明参考来源（章节或参考书目）
  - 数据录入前需经过人工审校
  - 建立数据质量检查清单（必填字段、格式规范、逻辑一致性）

- **LLM 回答质量**：
  - 提示词设计：明确要求基于原文和知识库回答，禁止编造
  - 回答审核：定期检查 LLM 回答，收集用户反馈
  - 错误处理：用户反馈错误后，记录并改进提示词

#### 8.3.2 版权合规
- **文本版权**：
  - 使用公开版权版本（古籍公共版权）或自有 OCR 成果
  - 禁止使用受版权保护的现代译本（除非获得授权）
  - 在页面底部注明文本来源

- **图片版权**：
  - 人物画像：使用公共领域图片或获得授权的图片
  - 地图底图：使用开放地图（OpenStreetMap）或自绘底图
  - 所有图片需注明来源

- **数据使用**：
  - 禁止将数据用于商业用途（除非获得授权）
  - 用户生成内容（如笔记）归用户所有

#### 8.3.3 用户隐私
- **数据收集**：
  - MVP 阶段：不收集用户个人信息
  - 阅读进度：仅存储在浏览器本地（localStorage）
  - 反馈数据：如用户提供联系方式，仅用于回复反馈

- **第三方服务**：
  - LLM 服务：使用 API，不存储用户问题到第三方（除非明确告知）
  - 分析工具：如使用 Google Analytics，需告知用户

### 8.4 安全性

#### 8.4.1 前端安全
- **XSS 防护**：
  - 所有用户输入（如搜索框、问题输入）进行转义
  - 使用 React 等框架的自动转义机制
  - 禁止使用 `dangerouslySetInnerHTML`（除非必要且经过审核）

- **CSRF 防护**：
  - API 请求使用 CSRF token（如有需要）
  - 敏感操作（如内容管理）需额外验证

#### 8.4.2 后端安全
- **API 安全**：
  - 所有 API 请求需验证参数格式和范围
  - 防止 SQL 注入（使用参数化查询）
  - 防止 NoSQL 注入（验证输入类型）

- **内容管理安全**：
  - 管理后台需密码保护（MVP 可硬编码，生产环境需认证）
  - 操作日志：记录所有数据修改操作（时间、操作人、内容）

### 8.5 可维护性

#### 8.5.1 代码质量
- **代码规范**：
  - 使用 TypeScript，严格模式
  - 遵循 ESLint/Prettier 规范
  - 代码注释：关键逻辑需注释说明

- **测试要求**（MVP 后完善）：
  - 单元测试覆盖率：≥60%
  - 关键功能（如数据加载、LLM 调用）需集成测试

#### 8.5.2 文档要求
- **技术文档**：
  - API 文档：使用 OpenAPI/Swagger 格式
  - 数据模型文档：说明所有数据结构
  - 部署文档：说明部署流程和环境要求

- **用户文档**（可选）：
  - 使用指南：说明主要功能使用方法
  - FAQ：常见问题解答

---

## 9. 后续扩展（不在本次范围，仅供参考）

### 9.1 用户功能扩展
- **用户账号系统**：
  - 注册/登录（邮箱、微信、GitHub OAuth）
  - 个人资料管理
  - 阅读历史云端同步（跨设备）

- **个性化功能**：
  - 自定义标注：用户可在段落中添加个人笔记
  - 书签：收藏重要段落
  - 阅读计划：设置每日阅读目标，追踪完成情况
  - 个性化推荐：基于阅读历史推荐相关章节

- **社交功能**（可选）：
  - 分享阅读笔记到社交媒体
  - 用户评论与讨论（需审核）
  - 阅读小组：多人共读同一章节

### 9.2 内容扩展
- **多书籍支持**：
  - 支持《资治通鉴》《汉书》《后汉书》等多部史书
  - 书籍间交叉引用：如《史记》中的人物在《资治通鉴》中的出现
  - 跨章节对比：对比不同章节中同一人物的描述

- **内容类型扩展**：
  - 支持更多注释类型（地理变迁、制度演变等）
  - 支持图片、音频、视频等多媒体内容
  - 支持用户贡献内容（UGC，需审核）

- **数据丰富化**：
  - 自动从 LLM 生成人物/事件摘要（需人工审核）
  - 自动识别文本中的人物/地点/事件（NER 技术）
  - 自动构建关系图谱（需人工校验）

### 9.3 技术扩展
- **移动端原生应用**：
  - iOS/Android 原生应用
  - 离线阅读支持
  - 推送通知（阅读提醒、新内容通知）

- **语音功能**：
  - 文本转语音（TTS）：朗读原文
  - 语音问答：语音输入问题，语音回答
  - 语音讲解：AI 生成的历史讲解音频

- **AI 功能增强**：
  - 多模型支持：支持 GPT-4、Claude、本地模型等
  - 自定义提示词：用户可调整 LLM 回答风格
  - AI 生成摘要：自动生成章节摘要、人物对比等

### 9.4 数据分析
- **用户行为分析**：
  - 阅读时长、完成率、跳转路径等
  - 热门章节、热门人物、热门问题
  - 用户反馈汇总与分析

- **内容质量分析**：
  - LLM 回答准确率统计
  - 用户反馈趋势分析
  - 数据质量报告

### 9.5 商业化（如适用）
- **付费功能**（可选）：
  - 高级 LLM 模型访问（GPT-4）
  - 无限制提问次数
  - 导出阅读笔记、关系图谱等

- **企业版**（可选）：
  - 定制化内容（企业内训、教育机构）
  - API 访问权限
  - 数据分析报告

---

## 10. 附录

### 10.1 术语表
- **节点（Node）**：知识图谱中的实体，如人物、地点、事件
- **边（Edge）**：知识图谱中节点之间的关系
- **上下文（Context）**：发送给 LLM 的输入信息，包括当前段落、相关人物/地点等
- **流式输出（Streaming）**：LLM 逐字返回回答，而非一次性返回
- **GeoJSON**：地理数据的 JSON 格式标准

### 10.2 参考资源
- 《史记》中华书局版
- 《资治通鉴》中华书局版
- OpenStreetMap: https://www.openstreetmap.org/
- Leaflet.js: https://leafletjs.com/
- vis.js: https://visjs.org/

### 10.3 版本历史
- **v1.0** (2024-01-XX): MVP 版本，包含核心阅读、人物关系、地图时间轴、LLM 问答功能

---

**文档结束**
