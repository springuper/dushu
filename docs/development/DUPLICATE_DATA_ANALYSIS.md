# 重复数据问题分析报告

## 执行时间
2026-01-04

## 问题背景

在导入《项羽本纪》章节数据后，发现了一些新的提取的人物、事件、地点。其中人物有一些看起来是和既有的数据是重合的，但是出现了一些变化，特别是：

- **萧何**在《项羽本纪》中被标记为 `OTHER` 阵营，而在《高祖本纪》中已被标记为 `HAN` 阵营
- 类似的情况还出现在其他多个人物身上

## 数据现状

### 1. 已发布数据统计

- **人物总数**: 79
- **事件总数**: 80
- **地点总数**: 123
- **重复记录**: 0（已发布数据中没有重复）

### 2. 待审核数据统计

- **待审核人物**: 85 条（全部来自《项羽本纪》）
- **待审核事件**: 58 条
- **待审核地点**: 0 条

### 3. 阵营冲突详情

发现 **28 个阵营冲突**，即同一人物在待审核数据和已发布数据中被标记为不同的阵营：

| 人物 | 待审核阵营 | 已发布阵营 | 待审核来源 | 已发布来源 |
|------|-----------|-----------|-----------|-----------|
| 萧何 | OTHER | HAN | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 樊噲 | OTHER | HAN | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 吕雉 | OTHER | HAN | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 陈平 | OTHER | HAN | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 张耳 | OTHER | HAN | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 陆贾 | OTHER | HAN | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 董翳 | OTHER | HAN | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 樅公 | OTHER | HAN | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 周苛 | OTHER | HAN | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 魏豹 | OTHER | CHU | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 吕青 | OTHER | CHU | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 吕臣 | OTHER | CHU | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 熊心 | OTHER | CHU | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 司马欣 | OTHER | CHU | 史记 - 项羽本纪 | 史记 - 高祖本纪 |
| 曹咎 | OTHER | CHU | 史记 - 项羽本纪 | 史记 - 高祖本纪 |

### 4. 待审核数据特点

- **所有待审核人物都被标记为 `OTHER` 阵营**
- **所有待审核人物都被标记为 `OTHER` 角色**
- 这表明 LLM 在提取《项羽本纪》时，由于该章节主要聚焦于项羽的视角，对于其他阵营的人物，LLM 可能无法准确判断其阵营归属

## 核心问题分析

### 问题 1: 人物阵营判断的上下文局限性

**现象**: 
- LLM 在提取人物信息时，只基于当前章节的上下文来判断阵营
- 在《项羽本纪》中，由于视角聚焦于项羽，其他人物（如萧何、樊噲等）可能被标记为 `OTHER`

**原因**:
- LLM 提取时没有访问已有人物数据库
- 没有跨章节的上下文信息
- 人物在不同历史时期的阵营可能确实会变化

**影响**:
- 创建重复的人物记录
- 阵营信息不一致
- 需要人工审核和合并

### 问题 2: 人物去重机制不完善

**现状**:
- 系统已有 `findExistingPerson()` 函数用于查找已存在的人物
- 但在创建 ReviewItem 时，并没有进行去重检查
- 只有在审核通过时才会检查重复

**影响**:
- 大量重复的 ReviewItem 被创建
- 增加了审核工作量
- 可能导致数据不一致

### 问题 3: 人物属性合并策略不明确

**现状**:
- 审核通过时，如果发现已存在人物，会进行合并
- 合并策略：
  - 别名：合并去重
  - 简介：保留更长的
  - 来源章节：合并
  - **阵营和角色：直接使用新数据的值**（这可能有问题）

**问题**:
- 阵营和角色的合并策略可能不合理
- 如果新数据的阵营是 `OTHER`，而旧数据是 `HAN`，应该保留哪个？
- 需要考虑数据来源的权威性

### 问题 4: 地点和事件的重复问题

**现状**:
- 地点和事件也可能存在重复
- 目前没有发现明显的重复，但需要建立预防机制

## 解决方案建议

### 方案 1: 改进 LLM 提取时的上下文

**思路**: 在提取时，向 LLM 提供已有人物信息作为参考

**优点**:
- 减少重复提取
- 提高阵营判断准确性
- 保持数据一致性

**缺点**:
- 增加 LLM 调用成本
- 需要修改提取逻辑

**实施难度**: 中等

### 方案 2: 在创建 ReviewItem 时进行去重检查

**思路**: 
- 在创建 ReviewItem 之前，先检查是否已存在相同的人物/地点/事件
- 如果存在，可以选择：
  - 直接合并到已存在记录（更新 sourceChapterIds）
  - 创建 ReviewItem 但标记为"待合并"
  - 创建 ReviewItem 但附加已存在记录的引用

**优点**:
- 减少重复数据
- 提前发现问题
- 简化审核流程

**缺点**:
- 需要更复杂的匹配逻辑
- 可能误判（同名不同人）

**实施难度**: 中等

### 方案 3: 改进审核时的合并策略

**思路**: 
- 对于阵营和角色，采用更智能的合并策略：
  - 如果旧数据是具体阵营（HAN/CHU），新数据是 `OTHER`，保留旧数据
  - 如果两者都是具体阵营但不同，需要人工判断或标记为冲突
  - 考虑数据来源的权威性（如《高祖本纪》对刘邦阵营的人物更权威）

**优点**:
- 保持数据质量
- 减少人工修正工作

**缺点**:
- 需要定义复杂的合并规则
- 可能需要人工介入

**实施难度**: 低到中等

### 方案 4: 建立人物阵营的时间维度

**思路**: 
- 人物阵营可能在不同历史时期发生变化
- 可以考虑：
  - 为人物添加"阵营历史"字段，记录不同时期的阵营
  - 在事件中记录人物在该事件中的阵营（而不是全局阵营）

**优点**:
- 更准确地反映历史事实
- 解决阵营变化的问题

**缺点**:
- 数据结构更复杂
- 需要修改数据模型

**实施难度**: 高

### 方案 5: 建立去重和合并的自动化工具

**思路**:
- 创建专门的去重检测工具
- 提供批量合并功能
- 支持人工审核和自动合并的混合模式

**优点**:
- 可以定期清理重复数据
- 支持批量操作

**缺点**:
- 需要额外的工具开发
- 需要人工审核确认

**实施难度**: 中等

## 推荐方案组合

建议采用以下组合方案：

1. **短期（立即实施）**: 
   - 方案 3：改进审核时的合并策略
   - 方案 5：建立去重检测工具

2. **中期（1-2周内）**:
   - 方案 2：在创建 ReviewItem 时进行去重检查

3. **长期（1-2个月内）**:
   - 方案 1：改进 LLM 提取时的上下文
   - 方案 4：考虑建立人物阵营的时间维度（如果确实需要）

## 具体实施建议

### 1. 改进合并策略（方案 3）

在 `backend/src/routes/review.ts` 中的合并逻辑中，改进阵营和角色的合并：

```typescript
// 阵营合并策略
function mergeFaction(existing: Faction, newFaction: Faction): Faction {
  // 如果旧数据是具体阵营，新数据是 OTHER，保留旧数据
  if (existing !== 'OTHER' && newFaction === 'OTHER') {
    return existing
  }
  // 如果新数据是具体阵营，旧数据是 OTHER，使用新数据
  if (existing === 'OTHER' && newFaction !== 'OTHER') {
    return newFaction
  }
  // 如果两者都是具体阵营，保留旧数据（需要人工审核）
  if (existing !== 'OTHER' && newFaction !== 'OTHER' && existing !== newFaction) {
    // 标记为冲突，需要人工审核
    return existing // 暂时保留旧数据
  }
  return existing
}
```

### 2. 创建去重检测工具（方案 5）

创建 `backend/scripts/detect_duplicates.ts`，定期运行检测重复数据。

### 3. 在创建 ReviewItem 时去重（方案 2）

在 `backend/src/routes/chapters.ts` 的提取逻辑中，创建 ReviewItem 之前先检查是否已存在。

## 下一步行动

1. **讨论和确认方案**: 与团队讨论上述方案，确定优先级
2. **实施短期方案**: 先实施方案 3 和方案 5
3. **测试和验证**: 在测试环境中验证改进效果
4. **逐步优化**: 根据实际使用情况，逐步实施中期和长期方案

## 附录

### 相关文件

- `backend/src/routes/review.ts` - 审核逻辑
- `backend/src/routes/chapters.ts` - 章节提取逻辑
- `backend/src/routes/persons.ts` - 人物管理逻辑
- `backend/scripts/analyze_duplicates.ts` - 重复数据分析脚本
- `backend/scripts/check_review_items.ts` - 待审核数据检查脚本
- `backend/scripts/analyze_source_chapters.ts` - 来源章节分析脚本

### 数据查询命令

```bash
# 分析重复数据
cd backend && npx tsx scripts/analyze_duplicates.ts

# 检查待审核数据
cd backend && npx tsx scripts/check_review_items.ts

# 分析来源章节
cd backend && npx tsx scripts/analyze_source_chapters.ts
```

